<?xml version="1.0" encoding="utf-8"?>
<!--
* Modified in 1.0.5 to:
 - Fix the bug that order lang is overwritten by MyParcelNL lang
-->
<modification>
    <name>MyParcel NL</name>
    <version>1.1.17</version>
    <code>MyParcelNL</code>
    <author>MyParcel NL</author>
    <link>https://www.myparcel.nl/</link>

    <!-- checked with compatible with Opencart 1x-->
    <!-- yes is compatible, no is no compatible -->
    <!-- ****************** ORDER_LIST.TWIG ******************* -->
    <!-- ***************************************************** -->
    <file path="admin/view/template/sale/order_list.twig"><!-- checked -->
        <operation><!-- yes -->
            <search regex="true"><![CDATA[/<td(.*)column_action(.*)<\/td>/]]></search>
            <add><![CDATA[
                <td>Ship To</td>

                <td$1column_header_myparcel$2</td>

                <td$1column_action$2</td>
            ]]></add>
        </operation>

        <operation>
            <search regex="true"><![CDATA[/<td(.*)order.date_modified(.*)<\/td>/]]></search>
            <add><![CDATA[
                <td$1order.date_modified$2</td>
                <!-- ~~~ Tap.Nguyen ~~~ -->
                <td class="shipping_address" class="text-left">
                    <div class="oc_shipment_options">
                      {{ order.mp_packet_type }}
                      <div class="oc_shipment_options_form" style="display: none;">
                        {{ order.ship_to_myparcel }}
                      </div>
                    </div>
                </td>
                <!-- Tap.Nguyen -->

                <td class="text-right" id="column-myparcel-order-{{ order.order_id }}">{{ order.column_myparcel }}</td>
            ]]></add>
        </operation>

        <operation><!-- no -->
            <search regex="true"><![CDATA[/<td(.*)order.order_status(.*)<\/td>/]]></search>
            <add><![CDATA[
                <td id="column-status-order-{{ order.order_id }}"$1order.order_status$2</td>
            ]]></add>
        </operation>

        <operation><!-- yes -->
            <search><![CDATA[<div id="content">]]></search>
            <add position="after"><![CDATA[
                {{ myparcel_popup_modal }}
            ]]></add>
        </operation>

        <operation><!-- no -->
            <search regex="true"><![CDATA[/<button(.*)button_shipping_print(.*)<\/button>/]]></search>
            <add><![CDATA[
                {{ print_batch }}
                {{ export_batch }}
                {{ export_print_batch }}
                <button$1button_shipping_print$2</button>
            ]]></add>
        </operation>

        <operation><!-- no -->
            <search><![CDATA[$('#button-shipping, #button-invoice').prop('disabled', true);]]></search>
            <add position="after"><![CDATA[
                $('#button-print-batch').prop('disabled', true);
                $('#button-export-batch').prop('disabled', true);
                $('#button-export-print-batch').prop('disabled', true);
            ]]></add>
        </operation>

        <operation><!-- no -->
            <search><![CDATA[$('#button-invoice').prop('disabled', false);]]></search>
            <add position="after"><![CDATA[
                $('#button-print-batch').prop('disabled', false);
                $('#button-export-batch').prop('disabled', false);
                $('#button-export-print-batch').prop('disabled', false);
            ]]></add>
        </operation>

        <operation>
            <search><![CDATA[$('input[name*=\'selected\']').prop('checked', this.checked);"]]></search>
            <add position="replace"><![CDATA[$('input[name*=\'selected\']').prop('checked', this.checked);" class="checkbox-for-all"]]></add>
        </operation>
    </file>

    <!-- ****************** ORDER_INFO.TWIG ******************* -->
    <!-- ***************************************************** -->
    <file path="admin/view/template/sale/order_info.twig"><!-- checked -->
        <operation><!-- yes -->
            <search regex="true" limit="1"><![CDATA[/{\% if shipping_method \%}(?s)(.*?)endif \%}/]]></search>
            <add offset="1"><![CDATA[
                {% if shipping_method %}$1$2endif %}

                <!-- MyParcel Hooks -->

                {{ myparcel_actions }}

                <!-- ~~~ Tap.Nguyen ~~~ -->
                <tr>
                    {{ tracktrace }}
                </tr>

                <tr>
                    {{ shipment_sumary }}
                </tr>

                <tr>
                    {{ checkout_delivery_options }}
                </tr>

                <tr>
                    {{ checkout_delivery_details }}
                </tr>
                <!-- Tap.Nguyen -->

                {{ myparcel_popup_modal }}
            ]]>
            </add>
        </operation>
    </file>

    <!-- ****************** HEADER.TWIG ******************* -->
    <!-- ***************************************************** -->
    <file path="admin/view/template/common/header.twig"><!-- checked -->
        <operation><!-- yes -->
            <search><![CDATA[</head>]]></search>
            <add position="before"><![CDATA[
                {{ myparcel_order_header }}
                <script>var is_opencart1 = false;</script>
            ]]>
            </add>
        </operation>
    </file>

    <!-- ****** ORDER CONTROLLER ADMIN/SALE/ORDER.PHP ****** -->
    <!-- *************************************************** -->

    <file path="admin/controller/sale/order.php"><!-- checked -->
        <!-- 1X -->
        <operation><!-- yes -->
            <search><![CDATA[
            public function index() {
            ]]></search>
            <add position="after"><![CDATA[
                $this->load->model('extension/myparcelnl/helper');
                $this->document->addStyle($this->model_extension_myparcelnl_helper->getCssUrl() . 'order.css');
                $this->document->addStyle($this->model_extension_myparcelnl_helper->getCssUrl() . 'sweetalert.min.css');
                $this->document->addScript($this->model_extension_myparcelnl_helper->getJsUrl() . 'order.js');
                $this->document->addScript($this->model_extension_myparcelnl_helper->getJsUrl() . 'sweetalert.min.js');
            ]]></add>
        </operation>

        <operation><!-- yes -->
            <search><![CDATA[
             public function info() {
            ]]></search>
            <add position="after"><![CDATA[
                $this->load->model('extension/myparcelnl/helper');
                $this->document->addStyle($this->model_extension_myparcelnl_helper->getCssUrl() . 'order.css');
                $this->document->addStyle($this->model_extension_myparcelnl_helper->getCssUrl() . 'sweetalert.min.css');
                $this->document->addScript($this->model_extension_myparcelnl_helper->getJsUrl() . 'order.js');
                $this->document->addScript($this->model_extension_myparcelnl_helper->getJsUrl() . 'sweetalert.min.js');
            ]]></add>
        </operation>

        <operation><!-- yes -->
            <search><![CDATA[
            public function getForm() {
            ]]></search>
            <add position="after"><![CDATA[
                $this->load->model('extension/myparcelnl/helper');
                $this->document->addStyle($this->model_extension_myparcelnl_helper->getCssUrl() . 'order.css');
                $this->document->addStyle($this->model_extension_myparcelnl_helper->getCssUrl() . 'sweetalert.min.css');
                $this->document->addScript($this->model_extension_myparcelnl_helper->getJsUrl() . 'order.js');
                $this->document->addScript($this->model_extension_myparcelnl_helper->getJsUrl() . 'sweetalert.min.js');
                $data['use_addition_address'] =  Myparcel($this->registry)->settings->general->use_addition_address_as_number_suffix;
            ]]></add>
        </operation>

        <operation><!-- yes -->
            <search regex="true"><![CDATA[/'customer'(.*)=> \$result\['customer'],/]]></search>
            <add><![CDATA[
                'customer'$1=> $result['customer'],
                'column_myparcel'           => $this->model_extension_myparcelnl_helper->getContent('column_myparcel', array('order_id' => $result['order_id'])),
                'ship_to_myparcel'       => $this->model_extension_myparcelnl_helper->getContent('ship_to_myparcel', array('order_id' => $result['order_id'])),
                'mp_packet_type' => $this->model_extension_myparcelnl_helper->getContent('myparcel_packet_type', array('order_id' => $result['order_id'])),
            ]]></add>
        </operation>

        <operation><!-- no -->
            <search regex="true"><![CDATA[/\$data\['user_token'](.*);/]]></search>
            <add><![CDATA[
                $data['user_token']$1;
                $data['column_header_myparcel'] = $this->model_extension_myparcelnl_helper->getContent('column_header_myparcel');
                $data['myparcel_popup_modal'] = $this->model_extension_myparcelnl_helper->getContent('myparcel_popup_modal');
            ]]></add>
        </operation>

        <!--
            Add the contents from controller in order to render in order_info.twig
        -->
        <operation>
            <search><![CDATA[$customer_group_info = $this->model_customer_customer_group->getCustomerGroup($order_info['customer_group_id']);]]></search>
            <add position="after"><![CDATA[
                $data['tracktrace'] = $this->model_extension_myparcelnl_helper->getContent('myparcel_tracktrace', array('order_id' => $this->request->get['order_id']));
                $data['shipment_sumary'] = $this->model_extension_myparcelnl_helper->getContent('myparcel_shipment_summary', array('order_id' => $this->request->get['order_id']));
                $data['myparcel_actions'] = $this->model_extension_myparcelnl_helper->getContent('order_details_myparcel_actions', array('order_id' => $order_info['order_id']));
                $data['checkout_delivery_options'] = $this->model_extension_myparcelnl_helper->getContent('myparcel_admin_checkout_delivery_options', array('order_id' => $order_info['order_id']));
                $data['checkout_delivery_details'] = $this->model_extension_myparcelnl_helper->getContent('myparcel_admin_checkout_delivery_details', array('order_id' => $order_info['order_id']));
                $data['myparcel_popup_modal'] = $this->model_extension_myparcelnl_helper->getContent('myparcel_popup_modal');
            ]]></add>
        </operation>

        <operation>
            <search><![CDATA[$data['invoice'] = $this->url->link('sale/order/invoice', 'user_token=' . $this->session->data['user_token'], true);]]></search>
            <add position="before"><![CDATA[
                $this->load->model('extension/myparcelnl/helper');
                $data['print_batch'] = $this->model_extension_myparcelnl_helper->getContent('print_batch', array());
                $data['export_batch'] = $this->model_extension_myparcelnl_helper->getContent('export_batch', array());
                $data['export_print_batch'] = $this->model_extension_myparcelnl_helper->getContent('export_print_batch', array());
            ]]></add>
        </operation>

        <operation>
            <search><![CDATA[$results = $this->model_sale_order->getOrders($filter_data);]]></search>
            <add position="after"><![CDATA[
                MyParcel()->shipment->shipment_helper->syncShipmentForOrders($results);
            ]]></add>
        </operation>

    </file>

    <!-- ****** ADMIN COMMON HEADER CONTROLLER ADMIN/CONTROLLER/COMMON/HEADER.PHP ****** -->
    <!-- ************************************************************************* -->

    <file path="admin/controller/common/header.php"><!-- checked -->
        <operation><!-- yes -->
            <search><![CDATA[
            public function index() {
            ]]></search>
            <add position="after"><![CDATA[
                /* MyParcel Ocmod Start */
                    $this->load->model('extension/myparcelnl/helper');
                    $data['myparcel_order_header'] = $this->model_extension_myparcelnl_helper->getContent('myparcel_order_header');
                /* MyParcel Ocmod End */
            ]]></add>
        </operation>
    </file>

    <!-- ****** CATALOG COMMON HEADER CONTROLLER CATALOG/CONTROLLER/COMMON/HEADER.PHP ****** -->
    <!-- ************************************************************************* -->

    <file path="catalog/controller/common/header.php"><!-- checked -->
        <operation><!-- yes -->
            <search><![CDATA[
            public function index() {
            ]]></search>
            <add position="after"><![CDATA[
                      /* MyParcel Ocmod Start */
                    $this->load->model('extension/myparcelnl/helper');
                    $this->model_extension_myparcelnl_helper->addCompatibleScript('myparcel_global', $this->document);
                    $this->document->addStyle($this->model_extension_myparcelnl_helper->getCssUrl() . 'myparcel_global.css');
                    $data['myparcel_delivery_checkout_header'] = $this->model_extension_myparcelnl_helper->getContent('iframe_delivery_checkout_header');
                /* MyParcel Ocmod End */
            ]]></add>
        </operation>
    </file>

    <!-- ****** Send info tracktrace via email ****** -->
    <!-- *************************************************** -->
    <file path="catalog/controller/mail/order.php"><!-- checked -->
        <operation><!-- no -->
            <search><![CDATA[$data['order_id'] = $order_info['order_id'];]]></search>
            <add position="after"><![CDATA[
                $this->load->model('extension/myparcelnl/helper');
                $data['tracktrace'] = $this->model_extension_myparcelnl_helper->getContent('myparcel_email_tracktrace', array('order_id' => $order_info['order_id']));
            ]]></add>
        </operation>
        <operation><!-- no -->
            <search><![CDATA[// Vouchers]]></search>
            <add position="before"><![CDATA[
                if(isset($this->session->data['myparcel']['data'])){
                    $myparcel = str_replace('&quot;','"',$this->session->data['myparcel']['data']);
                    $myparcel = json_decode($myparcel,true);
                    if(isset($myparcel['location'])){
                        $language->load('extension/module/myparcel');
                        $data['text_pickup_location'] = 'Pickup Location';
                        $data['pickup_location'] = implode("<br>", array($myparcel['location'],$myparcel['street'] . ' ' . $myparcel['number'], $myparcel['city'] . ' (' . $myparcel['distance'] . 'm)'));
                    }
                }
                else if(isset($this->session->data['myparcel_order_id'])){
                    $this->load->model('extension/myparcelnl/shipment');
                    $myparcel_delivery_options = $this->model_extension_myparcelnl_shipment->getMyParcelDeliveryOptions($this->session->data['myparcel_order_id']);
                    if(isset($myparcel_delivery_options['location'])){
                        $data['text_pickup_location'] = 'Pickup Location';
                        $data['pickup_location'] = implode("<br>", array($myparcel_delivery_options['location'],$myparcel_delivery_options['street'] . ' ' . $myparcel_delivery_options['number'], $myparcel_delivery_options['city'] . ' (' . $myparcel_delivery_options['distance'] . 'm)'));
                    }
                }
                if(!isset($data['pickup_location'])){
                    if(isset($this->session->data['myparcel_shipping_choosed'])){
                        $myparcel_delivery_options = $this->session->data['myparcel_shipping_choosed'];
                        if(isset($myparcel_delivery_options['location'])){
                            $data['text_pickup_location'] = 'Pickup Location';
                            $data['pickup_location'] = implode("<br>", array($myparcel_delivery_options['location'],$myparcel_delivery_options['street'] . ' ' . $myparcel_delivery_options['number'], $myparcel_delivery_options['city'] . ' (' . $myparcel_delivery_options['distance'] . 'm)'));
                        }
                    }
                }
            ]]></add>
        </operation>
        <operation><!-- no -->
            <search><![CDATA['title' => $order_total['title'],]]></search>
            <add position="replace"><![CDATA[
                'title' => strip_tags($order_total['title']),
            ]]></add>
        </operation>
    </file>

    <file path="catalog/view/theme/*/template/mail/order_add.twig"><!-- checked -->
        <operation><!-- no -->
            <search regex="true"><![CDATA[/{{ download }}(?s)(.*?)endif %}/]]></search>
            <add><![CDATA[
                {{ download }}$1endif %}
                {% if tracktrace %} <p>{{ tracktrace.text }} {{ tracktrace.code|join(', ') }}</p> {% endif %}
            ]]></add>
        </operation>
        <operation><!-- no -->
            <search><![CDATA[<td style="font-size: 12px; border-right: 1px solid #DDDDDD; border-bottom: 1px solid #DDDDDD; background-color: #EFEFEF; font-weight: bold; text-align: left; padding: 7px; color: #222222;">{{ text_shipping_address }}</td>]]></search>
            <add position="after"><![CDATA[
                {% if pickup_location %}
                <td style="font-size: 12px; border-right: 1px solid #DDDDDD; border-bottom: 1px solid #DDDDDD; background-color: #EFEFEF; font-weight: bold; text-align: left; padding: 7px; color: #222222;">{{ text_pickup_location  }}</td>
                {% endif %}
            ]]></add>
        </operation>
        <operation><!-- no -->
            <search><![CDATA[<td style="font-size: 12px;	border-right: 1px solid #DDDDDD; border-bottom: 1px solid #DDDDDD; text-align: left; padding: 7px;">{{ shipping_address }}</td>]]></search>
            <add position="after"><![CDATA[
                {% if pickup_location %}
                  <td style="font-size: 12px;	border-right: 1px solid #DDDDDD; border-bottom: 1px solid #DDDDDD; text-align: left; padding: 7px;">{{ pickup_location }}</td>
                {% endif %}
            ]]></add>
        </operation>
    </file>
    <file path="catalog/model/checkout/order.php">
        <operation>
            <search><![CDATA[$mail->setText($message);]]></search>
            <add position="after"><![CDATA[
                $mail->setHtml(nl2br($message));
            ]]></add>
        </operation>
    </file>
    <!-- ________ CATALOG\VIEW\THEME\*\TEMPLATE\ACCOUNT\ORDER_LIST.TWIG ________ -->
    <!-- ______________________ VIEW ACCOUNT ORDER_LIST _______________________ -->
    <!-- ______________________________________________________________________ -->
    <file path="catalog/view/theme/*/template/account/order_list.twig"><!-- checked -->
        <operation><!-- no -->
            <search><![CDATA[<td class="text-left">{{ column_date_added }}</td>]]></search>
            <add position="after"><![CDATA[
                {% if is_show_track_trace %}
                    <td class="text-left">{{ entry_track_trace }}</td>
                {% endif %}
            ]]></add>
        </operation>
        <operation><!-- no -->
            <search><![CDATA[<td class="text-left">{{ order.date_added }}</td>]]></search>
            <add position="after"><![CDATA[
                {% if is_show_track_trace %}
                    <td class="text-left">{{ order.tracktrace_myaccount }}</td>
                {% endif %}
              <?php } ?>
            ]]></add>
        </operation>
    </file>

    <!-- ________ CATALOG\VIEW\THEME\*\TEMPLATE\ACCOUNT\ORDER_INFO.TWIG ________ -->
    <!-- ______________________ VIEW ACCOUNT ORDER_INFO _______________________ -->
    <!-- ______________________________________________________________________ -->
    <file path="catalog/view/theme/*/template/account/order_info.twig"><!-- checked -->
        <operation><!-- no -->
            <search><![CDATA[{{ header }}]]></search>
            <add position="after"><![CDATA[{{ myparcel_order_header }}]]></add>
        </operation>
    </file>

    <!-- ________________ CATALOG\CONTROLLER\ACCOUNT\ORDER.PHP ________________ -->
    <!-- ______________________ ACCOUNT ORDER CONTROLLER ______________________ -->
    <!-- ______________________________________________________________________ -->
    <file path="catalog/controller/account/order.php">
        <operation><!-- no -->
            <search><![CDATA[
                'view'       => $this->url->link('account/order/info', 'order_id=' . $result['order_id'], true),
            ]]></search>
            <add position="after"><![CDATA[
                'tracktrace_myaccount'     => $this->model_extension_myparcelnl_helper->getContent('tracktrace_myaccount', array('order_id' => $result['order_id'])),
            ]]></add>
        </operation>
        <operation><!-- yes -->
            <search><![CDATA[
                $order_total = $this->model_account_order->getTotalOrders();
            ]]></search>
            <add position="after"><![CDATA[
                if (!class_exists('MyParcel')) {
                    require_once DIR_SYSTEM . 'library/myparcelnl/class_myparcel.php';
                    MyParcel($this->registry);
                }
                $this->load->model('extension/myparcelnl/helper');
                $this->load->language('extension/module/myparcelnl');
                if(MyParcel()->settings->general->trackandtrace_myaccount){
                    $data['is_show_track_trace'] = MyParcel()->settings->general->trackandtrace_myaccount;
                    $data['entry_track_trace'] = $this->language->get('entry_track_trace');
                }
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[public function info() {]]></search>
            <add position="after"><![CDATA[
                $this->load->model('extension/myparcelnl/helper');
                $data['myparcel_order_header'] = $this->model_extension_myparcelnl_helper->getContent('myparcel_order_header');
                $this->document->addScript($this->model_extension_myparcelnl_helper->getJsUrl() . 'order.js');
            ]]></add>
        </operation>
    </file>

    <!-- ________________ admin/view/template/sale/order_form.twig ________________ -->
    <!-- _______________________ Admin Edit Order Template _______________________ -->
    <!-- _________________________________________________________________________ -->
    <file path="admin/view/template/sale/order_form.twig">
        <operation>
            <search><![CDATA[data: $('#tab-shipping input[type=\'text\'], #tab-shipping input[type=\'hidden\'], #tab-shipping input[type=\'radio\']:checked, #tab-shipping input[type=\'checkbox\']:checked, #tab-shipping select, #tab-shipping textarea'),]]></search>
            <add position="replace"><![CDATA[
                data: $('input[name=\'order_id\'], #tab-shipping input[type=\'text\'], #tab-shipping input[type=\'hidden\'], #tab-shipping input[type=\'radio\']:checked, #tab-shipping input[type=\'checkbox\']:checked, #tab-shipping select, #tab-shipping textarea'),
            ]]></add>
        </operation>

        <operation>
            <search regex="true"><![CDATA[/url:(.*)route=api\/cart\/products(.*)\,/]]></search>
            <add><![CDATA[
                url:$1route=api/cart/products$2,
                data: $('input[name=\'order_id\']'),
            ]]></add>
        </operation>

        <operation>
            <search regex="true"><![CDATA[/url:(.*)route=api\/shipping\/methods(.*)\,/]]></search>
            <add><![CDATA[
                url:$1route=api/shipping/methods$2,
                data: $('input[name=\'order_id\']'),
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[<input type="text" name="address_2" value="{{ payment_address_2 }}" id="input-payment-address-2" class="form-control" />]]></search>
            <add position="after"><![CDATA[
            {% if( use_addition_address  and use_addition_address == 2 ) %}
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label" for="input-payment-address-3">Address 3</label>
            <div class="col-sm-10">
                <input type="text" name="custom_field[address_3]" value="{% if (payment_custom_field.address_3) %}{{ payment_custom_field.address_3 }}{% endif %}" id="input-payment-address-3" class="form-control" />
                {% endif %}
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[<input type="text" name="address_2" value="{{ shipping_address_2 }}" id="input-shipping-address-2" class="form-control" />]]></search>
            <add position="after"><![CDATA[
            {% if( use_addition_address and use_addition_address == 2 ) %}
            </div>
        </div>
        <div class="form-group">
                <label class="col-sm-2 control-label" for="input-shipping-address-3">Address 3</label>
                <div class="col-sm-10">
                  <input type="text" name="custom_field[address_3]" value="{% if (shipping_custom_field.address_3) %}{{ shipping_custom_field.address_3 }}{% endif %}" id="input-shipping-address-3" class="form-control" />
                {% endif %}
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[$('#button-save').button('reset');]]></search>
            <add position="after"><![CDATA[
                $('#button-refresh').click();
            ]]></add>
        </operation>
    </file>

    <!-- ________________ catalog/view/theme/journal2/template/journal2/checkout/address_form.twig ________________ -->
    <!-- _______________________ All Address Form Info Template _______________________ -->
    <!-- _________________________________________________________________________ -->
    <file path="catalog/view/theme/journal2/template/journal2/checkout/address_form.twig">
        <operation>
            <search><![CDATA[id="input-{{ type }}-address-2" class="form-control"/>]]></search>
            <add position="after"><![CDATA[
            {% if( use_addition_address and use_addition_address == 2 ) %}
            </div>
                 <div class="form-group address-3-input">
                    <label class="col-sm-2 control-label" for="input-{{ type }}-address-3">Address 3</label>
                    <input type="text" name="{{ type }}_custom_field[address][address_3]" value="{{staticCall('Journal2Utils', 'getProperty', [order_data, type ~ '_custom_field.address.address_3', ''])}}" placeholder="Address 3" id="input-{{ type }}-address-3" class="form-control"/>
            {% endif %}
            ]]></add>
        </operation>
    </file>

    <!-- ________________ catalog/view/theme/journal2/template/journal2/checkout/checkout.twig ________________ -->
    <!-- _______________________ All Address Form Info Template _______________________ -->
    <!-- _________________________________________________________________________ -->
    <file path="catalog/view/theme/journal2/template/journal2/checkout/checkout.twig">
        <operation>
            <search><![CDATA[$('.checkout-cart').replaceWith(html);]]></search>
            <add position="after"><![CDATA[
            setInterval(function(){
                  var cookieValue = document.cookie;
                  cookieValue = cookieValue.split(';')
                  $.each( cookieValue, function( key, value ) {
                      value = value.split('=');
                      if($.trim(value[0]) == 'myparcel_empty_results' && value[1] == 1){
                          $('#journal-checkout-confirm-button').prop('disabled', true);
                      }
                  });
              }, 2000);
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[$(document).on('journal_checkout_shipping_changed', function (e, value) {]]></search>
            <add position="after"><![CDATA[
            document.cookie = "myparcel_empty_results=0";
            ]]></add>
        </operation>
    </file>

    <!-- ________________ catalog/view/theme/*/template/checkout/guest.twig ________________ -->
    <!-- _______________________ Billing Info Guest Template _______________________ -->
    <!-- _________________________________________________________________________ -->
    <file path="catalog/view/theme/*/template/checkout/guest.twig">
        <operation>
            <search><![CDATA[<input type="text" name="address_2" value="{{ address_2 }}" placeholder="{{ entry_address_2 }}" id="input-payment-address-2" class="form-control" />]]></search>
            <add position="after"><![CDATA[
            {% if( use_addition_address and use_addition_address == 2 ) %}
            </div>
                <div class="form-group">
                    <label class="control-label" for="input-payment-address-3">Address 3</label>
                    <input type="text" name="custom_field[address][address_3]" value="{% if (guest_custom_field.address_3) %}{{ guest_custom_field.address_3 }}{% endif %}" placeholder="Address 3" id="input-payment-address-3" class="form-control" />
            {% endif %}
            ]]></add>
        </operation>
    </file>

    <!-- ________________ catalog/controller/checkout/guest.php ________________ -->
    <!-- _______________________ Billing Info Guest Controller _______________________ -->
    <!-- _________________________________________________________________________ -->
    <file path="catalog/controller/checkout/guest.php">
        <operation>
            <search><![CDATA[$this->load->language('checkout/checkout');]]></search>
            <add position="before"><![CDATA[
            $this->load->model('extension/myparcelnl/helper');
            $data['use_addition_address'] =  MyParcel($this->registry)->settings->general->use_addition_address_as_number_suffix;
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[$json['error']['address_1'] = $this->language->get('error_address_1');]]></search>
            <add position="after"><![CDATA[
            }
            $this->load->model('extension/myparcelnl/helper');
                $use_addition_address =  MyParcel($this->registry)->settings->general->use_addition_address_as_number_suffix;
                if ($use_addition_address == 2 ) {
                    if (empty(trim($this->request->post['address_2']))) {
                        $json['error']['address_2'] = MyParcel()->lang->get('error_address_2');
                    }
            ]]></add>
        </operation>
    </file>

    <file path="catalog/controller/extension/module/xtensions/checkout/xpayment_address.php">
        <operation>
            <search><![CDATA[if (!$json['error'] && isset($this->request->get['showpayment'])) {]]></search>
            <add position="before"><![CDATA[
            //Myparcel plugin - start
            if($this->cart->hasShipping()  && isset($this->session->data['shipping_method']['code']) && ($this->session->data['shipping_method']['code'] == 'myparcel_delivery.myparcel_delivery' || $this->session->data['shipping_method']['code'] == 'myparcel_pickup.myparcel_pickup')){
                if (!class_exists('MyParcel')) {
                    require_once DIR_SYSTEM . 'library/myparcelnl/class_myparcel.php';
                    MyParcel($this->registry);
                }
                $myparcel_error = $this->load->controller(MyParcel()->getMyparcelXtensionControllerPath().'/externalValidate');
                if($myparcel_error){
                    $json['error'] = $myparcel_error;
                }
            }
            //Myparcel plugin - end
                ]]></add>
        </operation>
        <operation>
            <search><![CDATA[$this->template = $this->config->get('xtensions_view_path').'xpayment_address';]]></search>
            <add position="before"><![CDATA[
            if(isset($this->session->data['myparcel_api_errors'])){
                $this->data['myparcel_api_errors'] = $this->session->data['myparcel_api_errors'];
            }
            ]]></add>
        </operation>
    </file>

    <file path="catalog/controller/extension/module/xtensions/checkout/xpayment_method.php">
        <operation>
            <search><![CDATA[if(isset($this->request->get['direct'])){]]></search>
            <add position="before"><![CDATA[
            //Myparcel plugin - start
            if($this->cart->hasShipping()  && isset($this->session->data['shipping_method']['code']) && ($this->session->data['shipping_method']['code'] == 'myparcel_delivery.myparcel_delivery' || $this->session->data['shipping_method']['code'] == 'myparcel_pickup.myparcel_pickup')){
                if (!class_exists('MyParcel')) {
                    require_once DIR_SYSTEM . 'library/myparcelnl/class_myparcel.php';
                    MyParcel($this->registry);
                }
                $myparcel_error = $this->load->controller(MyParcel()->getMyparcelXtensionControllerPath().'/externalValidate');
                if($myparcel_error){
                    $json['error'] = $myparcel_error;
                }
            }
            //Myparcel plugin - end
                ]]></add>
        </operation>
    </file>
    <file path="catalog/controller/extension/module/xtensions/checkout/xlogin.php">
        <operation>
            <search><![CDATA[$json['next'] = $child['matter'];]]></search>
            <add position="before"><![CDATA[
            if(isset($this->session->data['shipping_address'])){
                $json['address_exit'] = 1;
            }
            ]]></add>
        </operation>
    </file>

    <file path="catalog/controller/extension/module/xtensions/checkout/xcvc.php">
        <operation>
            <search><![CDATA[$sort_order[$key] = $value['sort_order'];]]></search>
            <add position="after"><![CDATA[
            //Myparcel plugin - start
            //get pickup location
            if($value['code'] == 'shipping' && isset($this->session->data['myparcel_price_pickup'])
				&& isset($this->session->data['shipping_method']['code']) && strpos($this->session->data['shipping_method']['code'],$this->session->data['myparcel_price_pickup']['shipping_method_code']) !== false){
                $myparcel_delivery_options = $this->session->data['myparcel_price_pickup']['myparcel_shipping_choosed'];
                if(isset($myparcel_delivery_options['location'])){
                    $this->language->load('extension/module/myparcelnl');
                    $this->data['myparcel_pickup_price_summary']['title'] = $this->language->get('entry_title_location');
                    $this->data['myparcel_pickup_price_summary']['location'] = $myparcel_delivery_options['location']. ', ' .$myparcel_delivery_options['street'] . ' ' . $myparcel_delivery_options['number'] .', ' . $myparcel_delivery_options['city'];
                    $this->data['myparcel_pickup_price_summary']['shipping_title'] = $value['title'];
                }
            }
            //Myparcel plugin - end
                ]]></add>
        </operation>
    </file>
    <!-- ________________ catalog/controller/extension/module/xtensions/checkout/xshipping_method.php ________________ -->
    <!-- _______________________ XShipping Method Module _______________________ -->
    <!-- _________________________________________________________________________ -->
    <file path="catalog/controller/extension/module/xtensions/checkout/xshipping_method.php">
        <operation>
            <search><![CDATA[public function index() {]]></search>
            <add position="after"><![CDATA[
            $this->load->model('extension/myparcelnl/helper');
            $this->document->addStyle($this->model_extension_myparcelnl_helper->getCssUrl() . 'checkout.css');
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[array_multisort($sort_order, SORT_ASC, $quote_data);]]></search>
            <add position="after"><![CDATA[
            if (!class_exists('MyParcel')) {
                require_once DIR_SYSTEM . 'library/myparcelnl/class_myparcel.php';
                MyParcel($this->registry);
            }
            if(isset($this->session->data['shipping_method'])){
                if(isset($this->session->data['myparcel_shipping_choosed'])){
                    $shipping_method = $this->session->data['shipping_method'];
                    $myparcel_shipping_choosed = $this->session->data['myparcel_shipping_choosed'];
                    if(explode('.',$shipping_method['code'])[0] != $myparcel_shipping_choosed['code']){
                        unset($this->session->data['myparcel_shipping_choosed']);
                    }
                }
            }
            else{
                if(isset($this->session->data['myparcel_shipping_choosed'])){
                    unset($this->session->data['myparcel_shipping_choosed']);
                }
            }
            if (!empty($shipping_address) && ($shipping_address['iso_code_2'] == 'NL' || $shipping_address['iso_code_2'] == 'BE')) {
                $api = MyParcel()->api;
                $registry = MyParcel::$registry;
                /** @var \Cart\Currency $currency **/
                $currency = $registry->get('currency');
                $current_currency_code = $this->session->data['currency'];
                $shipment_class = MyParcel()->shipment;
                /** @var MyParcel_Shipment_Checkout $checkout_helper **/
                $checkout_helper = $shipment_class->checkout;
                $config = $registry->get('config');
                $myparcelnl_checkout_settings = $config->get('module_myparcelnl_fields_checkout');
                $default_price_0_text = isset($myparcelnl_checkout_settings['default_price_0_text']) ? $myparcelnl_checkout_settings['default_price_0_text'] : '';
                if(isset($myparcelnl_checkout_settings['enable_delivery']) && $myparcelnl_checkout_settings['enable_delivery'] == 1){
                    $delivery_params = MyParcel()->helper->getDeliveryParams($shipping_address);
                    $myparcel_delivery = $api->getDeliveryOptions($delivery_params);

                    if(isset($myparcel_delivery['code']) && $myparcel_delivery['code'] == 200 && !isset($myparcel_delivery['body']['errors'])){
                        $myparcel_delivery = MyParcel()->helper->formatDeliveryPrice($myparcel_delivery, $shipping_address ,$this->cart->getSubTotal(),$this->language,$current_currency_code);


                        $shipping_method_code = null;
                        $myparcel_option_title = [];
                        if (isset($this->session->data['shipping_method']['code'])){
                            $shipping_method_code = $this->session->data['shipping_method']['code'];
                            $shipping_method_code = explode('.',$shipping_method_code)[0];
                        }
                        $this->data['myparcel_option_title'] = array();
                        $arrMyparcelShippingKey = [];
                        foreach ($myparcel_delivery['body']['data'] as $key => $value){
                            if(count($value)) {
                                $sort_order = count($quote_data);
                                $key_delivery = 'myparcel_' . $key;
                                $cost = 0;
                                $cost_with_tax = 0;
                                $price_key = 'myparcel_price_' . $key;
                                if (!isset($this->session->data[$price_key])) {
                                    MyParcel()->helper->saveDefaultMyparcelMethodXtension($value,$key);
                                }
                                if (isset($this->session->data[$price_key])) {
                                    $myparcel_price = $this->session->data[$price_key];
                                    $text_price_detail = explode(' - ',$myparcel_price['text_myparcel_price_'.$key]);
                                    //recalculate price choose
                                    switch ($myparcel_price['shipping_method_code']){
                                        case 'delivery':
                                            foreach ($value as $k => $v){
                                                if(date('Y-m-d',strtotime($v['date'])) == date('Y-m-d',strtotime($text_price_detail[0]))){
                                                    foreach ($v['time'] as $time){
                                                        if(date('H:i',strtotime($time['start'])) == date('H:i',strtotime($text_price_detail[1])) && date('H:i',strtotime($time['end'])) == date('H:i',strtotime($text_price_detail[2]))){
                                                            $myparcel_price['amount'] = $time['price']['amount'];
                                                            $myparcel_price['amount_with_tax'] = $time['price']['amount_with_tax'];
                                                            break;
                                                        }
                                                    }
                                                }
                                            }
                                            break;
                                        case 'pickup':
                                            foreach ($value as $k => $v){
                                                if($v['location'] == trim($text_price_detail[0])){
                                                    foreach ($v['time'] as $time){
                                                        if(date('H:i',strtotime($time['start'])) == date('H:i',strtotime($text_price_detail[2])) ){
                                                            $myparcel_price['amount'] = $time['price']['amount'];
                                                            $myparcel_price['amount_with_tax'] = $time['price']['amount_with_tax'];
                                                            break;
                                                        }
                                                    }
                                                }
                                            }
                                            break;
                                    } // end recalculate price choose

                                    if ($myparcel_price['shipping_method_code'] == $key) {
                                        $cost = $currency->convert($myparcel_price['amount'], $myparcel_price['currency'], $current_currency_code);
                                        $cost_with_tax = $currency->convert($myparcel_price['amount_with_tax'], $myparcel_price['currency'], $current_currency_code);
                                    };
                                    if ($shipping_address['iso_code_2'] == 'NL' && isset($this->session->data['additional_service_checked'][$key])) {
                                        if (isset($this->session->data['additional_service'])) {
                                            $additional_service = $this->session->data['additional_service'];

                                            $delivery_prices = $checkout_helper->getDeliveryPrices(false, true, '', false, 0,$this->cart->getSubTotal());
                                            $delivery_prices_format = $checkout_helper->getDeliveryPrices(false, true, '', true, 0,$this->cart->getSubTotal());
                                            foreach ($additional_service as $service_name => $service_value) {
                                                if(isset($delivery_prices[$shipping_address['iso_code_2']][$service_name]) && $delivery_prices[$shipping_address['iso_code_2']][$service_name] !== 'disable'){
                                                    $additional_service[$service_name]['amount'] = round($currency->convert($delivery_prices[$shipping_address['iso_code_2']][$service_name],'EUR',$current_currency_code),2);
                                                    $additional_service[$service_name]['amount_with_tax'] = round($currency->convert($delivery_prices_format[$shipping_address['iso_code_2']][$service_name],'EUR',$current_currency_code),2);
                                                    $additional_service[$service_name]['text_amount'] = $currency->format($delivery_prices_format[$shipping_address['iso_code_2']][$service_name],$current_currency_code);
                                                }
                                            }
                                            $additional_service_checked = $this->session->data['additional_service_checked'][$key];
                                            foreach ($additional_service_checked as $service_name => $service_value) {
                                                if ($service_value) {
                                                    $cost += $additional_service[$service_name]['amount'];
                                                    $cost_with_tax += $additional_service[$service_name]['amount_with_tax'];
                                                }
                                            }
                                        }
                                    }
                                }
                                else{
                                    //delivery default select standard for delivery or first location for  pickup  if not selected
                                    switch ($key){
                                        case 'delivery':
                                            foreach ($value as $k => $v){
                                                foreach ($v['time'] as $k => $time){
                                                    if($time['price_comment'] == 'standard'){
                                                        $cost = $time['price']['amount'];
                                                        $cost_with_tax = $time['price']['amount_with_tax'];
                                                        break;
                                                    }
                                                }
                                            }
                                            break;
                                        case 'pickup':
                                            $pickup = $value[0];
                                            $time = $pickup['time'][0];
                                            $cost = $time['price']['amount'];
                                            $cost_with_tax = $time['price']['amount_with_tax'];
                                            break;
                                    }

                                }

                                $arrQuote = array(
                                    'code' => $key_delivery . '.' . $key_delivery,
                                    'title' => $this->language->get('entry_myparcel_' . $key),
                                    'cost' => $cost,
                                    'tax_class_id' => $checkout_helper->getTaxFromCart(),
                                    'text' => ($cost_with_tax == 0 && $default_price_0_text != '') ? $default_price_0_text :$currency->format($cost_with_tax, $current_currency_code),
                                );
                                $arrShipping = array(
                                    'title' => $this->language->get('entry_myparcel_' . $key),
                                    'sort_order' => $sort_order,
                                    'error' => ''
                                );
                                if ($shipping_method_code == $key_delivery) {
                                    $arrQuote['headingtitle'] = $this->language->get('entry_select_myparcel_' . $key);
                                }
                                $myparcel_option_title['title_heading_myparcel_' . $key] = $this->language->get('entry_select_myparcel_' . $key);
                                $myparcel_option_title['text_edit_myparcel_' . $key] = (isset($myparcel_price['text_myparcel_price_'.$key])) ? $myparcel_price['text_myparcel_price_'.$key] : $this->language->get('entry_edit_myparcel_' . $key);
                                $arrShipping['quote'][$key_delivery] = $arrQuote;
                                $quote_data[$key_delivery] = $arrShipping;
                                $arrMyparcelShippingKey[] = $key_delivery;
                            }
                        }
                        $this->session->data['myparcel_option_title'] = $myparcel_option_title;
                        $this->session->data['myparcel_delivery'] = $myparcel_delivery['body']['data'];
                        if(isset($this->session->data['myparcel_api_errors'])){
                            unset($this->session->data['myparcel_api_errors']);
                        }

                        //make myparcel shipping method to first.
                        if(count($arrMyparcelShippingKey)){
                            $arrMyparcelShippingKey = array_reverse($arrMyparcelShippingKey);
                            foreach ($arrMyparcelShippingKey as $key){
                                if(isset($quote_data[$key])) {
                                    $value = $quote_data[$key];
                                    unset($quote_data[$key]);
                                    $quote_data = array($key => $value) + $quote_data;
                                }
                            }
                        }
                    }
                    else{
                        if(isset($myparcel_delivery['body']['errors'])){
                            $myparcel_errors = $myparcel_delivery['body']['errors'];
                            $error_message = [];
                            if(is_array($myparcel_errors) && count($myparcel_errors)){
                                 foreach($myparcel_errors as $error){
                                    $error_language_key = 'entry_myparcel_api_error_code_' . $error['code'];
                                    $error_message[] = ($this->language->get($error_language_key) != $error_language_key) ? $this->language->get($error_language_key) : $error['message'];
                                }
                                $this->session->data['myparcel_api_errors'] = htmlspecialchars(implode('.',$error_message), ENT_QUOTES);
                            }
                        }
                    }}
                else{
                    if(isset($this->session->data['myparcel_api_errors'])){
                        unset($this->session->data['myparcel_api_errors']);
                    }
                }
            }
            else{
                if(isset($this->session->data['myparcel_api_errors'])){
                    unset($this->session->data['myparcel_api_errors']);
                }
            }
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[$this->template = $this->config->get('xtensions_view_path').'xshipping_method';]]></search>
            <add position="before"><![CDATA[
            if (!class_exists('MyParcel')) {
				require_once DIR_SYSTEM . 'library/myparcelnl/class_myparcel.php';
				MyParcel($this->registry);
			}
            if(isset($this->session->data['myparcel_api_errors'])){
                $this->data['myparcel_api_errors'] = $this->session->data['myparcel_api_errors'];
            }
            if(isset($this->session->data['myparcel_option_title'])){
                $this->data['myparcel_option_title'] = $this->session->data['myparcel_option_title'];
            }
            ($_SERVER['HTTPS'] && defined(HTTPS_SERVER)) ? $url_server = HTTPS_SERVER : $url_server = HTTP_SERVER;
            $this->data['myparcel_action'] = $url_server . 'index.php?route=' . MyParcel()->getMyparcelXtensionControllerPath();
            ]]></add>
        </operation>
    </file>

    <file path="catalog/view/theme/*/template/extension/module/xtensions/checkout/xcheckout.twig">
        <operation>
            <search><![CDATA[$(document).on("click", "#couponbtn1", function(event) {]]></search>
            <add position="before"><![CDATA[
                $(document).on("change", "input[name='myparcel_option']", function(event) {
                var element = this;
                showLoader();
                $.ajax({
                    url: 'index.php?route='+$(element).attr('action')+'/save',
                    type: 'post',
                    data: $('#xdeldateandtimeslots input[type=\'text\'], .xdeltimeslots-table input[type=\'radio\']:checked'),
                    dataType: 'json',
                    beforeSend: function() {

                    },
                    success: function(json) {
                        if(json['success']){
                            loadShippingMethods(true);
                            $('#modal-shipping-dependancy').modal('hide');
                        }
                        hideLoader();
                    }
                });
            });

            $(document).on("change", "select[name='myparcel_pickup_location']", function(event) {
                var element = this;
                showLoader();
                $.ajax({
                    url: 'index.php?route='+$(element).attr('action')+'/change',
                    type: 'post',
                    data: {
                        'myparcel_pickup_location': $('#myparcel_pickup_location :selected').val()
                    },
                    dataType: 'json',
                    beforeSend: function() {
                        $('.xdeldateandtimeslots .alert').remove();
                        $('.xdelslotselected').removeClass('xdelslotselected');
                        $(element).closest('tr').addClass('xdelslotselected');
                    },
                    success: function(json) {
                        if(json['error']){
                            if(json['error']['date']){
                                $('#xdeltimeslots').before('<div class="alert alert-warning">'+json['error']['date']+'<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
                            }
                            if(json['error']['timeslot']){
                                loadSlots();
                                $('#xdeltimeslots').before('<div class="alert alert-warning">'+json['error']['timeslot']+'<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
                            }
                        }else if(json['success']){
                            $('.myparcel-pickup-table').html(json['html']);
                            loadShippingMethods(true);
                        }
                        hideLoader();
                    }
                });
            });
            function changeAdditionalService(obj,name) {
                var element = obj;
                var id = obj.id.toString();
                console.log(id);
                $.ajax({
                    url: 'index.php?route='+$(obj).attr('action')+'/save',
                    type: 'post',
                    data: {
                        'addition_name' : name,
                        'addition_value': obj.checked
                    },
                    dataType: 'json',
                    beforeSend: function() {
                        $('.xdeldateandtimeslots .alert').remove();
                        $('.xdelslotselected').removeClass('xdelslotselected');
                        $(element).closest('tr').addClass('xdelslotselected');
                    },
                    success: function(json) {
                        if(json['error']){
                            if(json['error']['date']){
                                $('#xdeltimeslots').before('<div class="alert alert-warning">'+json['error']['date']+'<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
                            }
                            if(json['error']['timeslot']){
                                loadSlots();
                                $('#xdeltimeslots').before('<div class="alert alert-warning">'+json['error']['timeslot']+'<button type="button" class="close" data-dismiss="alert">&times;</button></div>');
                            }
                        }else if(json['success']){
                            loadShippingMethods();
                        }

                    }
                });
            };
            function loadMyparcelDelivery(action,headingtitle){
                $('#modal-shipping-dependancy').remove();
                $('.bootstrap-datetimepicker-widget').remove();
                $.ajax({
                    url: action,
                    type: 'post',
                    data: $('#shipping_method input[type=\'radio\']:checked'),
                    dataType: 'html',
                    beforeSend: function() {

                    },
                    success: function(data) {
                        html  = '<div id="modal-shipping-dependancy" class="modal modal_dependancy" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">';
                        html += '  <div class="modal-dialog">';
                        html += '    <div class="modal-content">';
                        html += '      <div class="modal-header">';
                        html += '        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>';
                        html += '        <h4 class="modal-title">'+headingtitle+'</h4>';
                        html += '      </div>';
                        html += '      <div class="modal-body">'+ data +'</div>';
                        html += '    </div';
                        html += '  </div>';
                        html += '</div>';
                        $('body').append(html);
                        $('#modal-shipping-dependancy').modal('show');
                    }
                });
            }
            $(document).on("hidden.bs.modal", "#modal-shipping-dependancy", function(event) {
                loadShippingMethods();
            });
            ]]></add>
        </operation>


        <operation>
            <search><![CDATA[function loadShippingMethods(){]]></search>
            <add position="after"><![CDATA[
            showLoader();
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[if(json.redirect){]]></search>
            <add position="before"><![CDATA[
            hideLoader();
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[}else if(json.xpayment_method){]]></search>
            <add position="before"><![CDATA[
            }else if(json.error){
                hideLoader();
                $('#button-payment').removeClass('progress-bar-striped active');
                alert(json.error.warning);
                if(json['error']['action']){
                    loadMyparcelDelivery(json['error']['action'],json['error']['title']);
                }
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[$('#step_payment_panel').html(json.xpayment_method);]]></search>
            <add position="before"><![CDATA[
            if(json.error){
                hideLoader();
                $('#button-payment').removeClass('progress-bar-striped active');
                alert(json.error.warning);
                if(json['error']['action']){
                    loadMyparcelDelivery(json['error']['action'],json['error']['title']);
                }
                return false;
            }
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[$('#step_address_panel').html(html);]]></search>
            <add position="after"><![CDATA[
            var eleError = $('#myparcel_api_errors');
            if(eleError.length){
                alert(eleError.val());
                var radioValue = $("input[name='address_id']:checked").val();
                var elementAddress = $('.editAddress');
                var clickEl;
                for(var i=0; i < elementAddress.length; i++){
                    var link = ($(elementAddress[i]).attr('link'));
                    if(link.indexOf('address_id=' + radioValue) > -1){
                        clickEl = $(elementAddress[i]);
                    }
                }
                clickEl.click();
            }
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[$('#addressModal_edit').modal('hide');]]></search>
            <add position="after"><![CDATA[
            var eleError = $('#myparcel_api_errors');
            if(eleError.length){
                alert(eleError.val());
                var radioValue = $("input[name='address_id']:checked").val();
                var elementAddress = $('.editAddress');
                var clickEl;
                for(var i=0; i < elementAddress.length; i++){
                    var link = ($(elementAddress[i]).attr('link'));
                    if(link.indexOf('address_id=' + radioValue) > -1){
                        clickEl = $(elementAddress[i]);
                    }
                }
                clickEl.click();
            }
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[$('#step_address_panel #shipping_method .shipping-table').html(json.shipping_method);]]></search>
            <add position="after"><![CDATA[
            var eleError = $('#myparcel_api_errors');
            if(eleError.length){
                alert(eleError.val());
                var radioValue = $("input[name='address_id']:checked").val();
                var elementAddress = $('.editAddress');
                if(elementAddress.length){
                    var clickEl;
                    for(var i=0; i < elementAddress.length; i++){
                        var link = ($(elementAddress[i]).attr('link'));
                        if(link.indexOf('address_id=' + radioValue) > -1){
                            clickEl = $(elementAddress[i]);
                        }
                    }
                    clickEl.click();
                }
                else{
                    toggleElement('#guestPanel, #guest_payment_panel');
                    $('.col-md-3.lborder').addClass('xblur');
                }
            }
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[$('#step_login_panel #totals').html(json.xtotals);]]></search>
            <add position="after"><![CDATA[
            loadShippingMethods();
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[} else if (json.xguest) {]]></search>
            <add position="after"><![CDATA[
            $.ajax({
                url : 'index.php?route=extension/myparcelnl/myparcel_xtension_delivery/forgetMyParcelChoosed',
                type: 'get',
                success:function (data) {
                    loadShippingMethods();
                }
            });
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[}else if (json.next) {]]></search>
            <add position="after"><![CDATA[
            if(json.address_exit){
                loadShippingMethods();
            }
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[$('#step_address_panel #shipping_method').html(json.xshipping_method);]]></search>
            <add position="after"><![CDATA[
            $.ajax({
                url : 'index.php?route=extension/myparcelnl/myparcel_xtension_delivery/forgetMyParcelChoosed',
                type: 'get',
                success:function (data) {
                    loadShippingMethods();
                }
            });
            ]]></add>
        </operation>
    </file>

    <file path="catalog/view/theme/*/template/extension/module/xtensions/checkout/xshipping_method.twig">
        <operation>
            <search><![CDATA[{% if shipping_methods  %}]]></search>
            <add position="before"><![CDATA[
            <script>
                $(document).ready(function() {
                    {%  if myparcel_api_errors %}
                        var eleError = $('#myparcel_api_errors');
                        if(eleError.length == 0){
                            $('body').append('<input type="hidden" id="myparcel_api_errors" value="{{  myparcel_api_errors }}">');
                        }
                    {%  else  %}
                        var eleError = $('#myparcel_api_errors');
                        if(eleError.length){
                            $(eleError).remove();
                        }
                    {% endif %}

                    var elms = $("input[id^='myparcel_']");
                    var myparcel_action = '{{ myparcel_action }}';
                    for(var i=0; i < elms.length; i++){
                        var id = elms[i].id;
                        if(id != 'myparcel_shipping.myparcel_shipping' && id != 'myparcel_api_errors'){
                            id = id.split('.');
                            var title = $('#title_heading_' + id[0]).val();
                            var textEdit = $('#text_edit_' + id[0]).val();
                            $(elms[i]).attr('onClick',"loadMyparcelDelivery('"+ myparcel_action +"','"+ title + "' )");
                            $(elms[i]).parent().parent().parent().addClass('myparcel');
                            var divEle = '<div class="editmyparcel" id="text_'+ id[0] +'">'+ textEdit +'</div>';
                            $(elms[i]).parent().append(divEle);
                        }
                    }
                });
            </script>
            {% if myparcel_option_title %}
                {% for  key , value in myparcel_option_title %}
                    <input type="hidden" id="{{ key }}" value="{{ value }}">
                {% endfor %}
            {% endif %}
            ]]></add>
        </operation>
    </file>

    <file path="catalog/view/theme/*/template/extension/module/xtensions/checkout/xtotals.twig">
        <operation>
            <search><![CDATA[<tr><td>{{ total.title }}:</td><td class="text-right">{{ total.text }}</td></tr>]]></search>
            <add position="after"><![CDATA[
            {% if  myparcel_pickup_price_summary and total.title == myparcel_pickup_price_summary.shipping_title %}
                <tr><td>{{ myparcel_pickup_price_summary.title }}:</td><td class="text-right">{{ myparcel_pickup_price_summary.location }} </td> </tr>
            {% endif %}
            ]]></add>
        </operation>
    </file>

    <file path="catalog/view/theme/*/template/extension/module/xtensions/checkout/xpayment_address.twig">
        <operation>
            <search><![CDATA[{% if force_redirect %}]]></search>
            <add position="before"><![CDATA[
                    <script>
                        $(document).ready(function () {
                            {%  if myparcel_api_errors %}
                            var eleError = $('#myparcel_api_errors');
                            if(eleError.length == 0){
                                $('body').append('<input type="hidden" id="myparcel_api_errors" value="{{  myparcel_api_errors }}">');
                            }
                            {%  else  %}
                            var eleError = $('#myparcel_api_errors');
                            if(eleError.length){
                                $(eleError).remove();
                            }
                            {% endif %}
                        });
                    </script>
                ]]></add>
        </operation>
    </file>
    <file path="catalog/controller/checkout/confirm.php">
        <operation>
            <search><![CDATA[$this->session->data['order_id'] = $this->model_checkout_order->addOrder($order_data);]]></search>
            <add position="after"><![CDATA[
            if(isset($this->session->data['myparcel_shipping_choosed']) && isset($this->session->data['shipping_method']['code'])
                        && ($this->session->data['shipping_method']['code'] == ($this->session->data['myparcel_shipping_choosed']['code'] . '.' . $this->session->data['myparcel_shipping_choosed']['code']))){
                if (!class_exists('MyParcel')) {
                    require_once DIR_SYSTEM . 'library/myparcelnl/class_myparcel.php';
                    MyParcel($this->registry);
                }
                $registry = MyParcel::$registry;
                $loader = $registry->get('load');
                $loader->model(MyParcel()->getModelPath('shipment'));
                $model_shipment = $registry->get('model_extension_myparcelnl_shipment');
                $myparcel_shipping_choosed = $this->session->data['myparcel_shipping_choosed'];
                $additional_service = $myparcel_shipping_choosed['additional_service'];
                $myparcel_shipping_code = $myparcel_shipping_choosed['code'];
                unset($myparcel_shipping_choosed['code']);
                unset($myparcel_shipping_choosed['additional_service']);
                $signed = (isset($additional_service['signed']) && $additional_service['signed'] ) ? 1: 0;
                $recipient_only = (isset($additional_service['only_recipient']) && $additional_service['only_recipient'] ) ? 1: 0;
                $current_prices = null;
                if(isset($this->session->data['additional_service'])){
                    $current_prices = array(
                        'NL' => $this->session->data['additional_service']
                    );
                }
                $model_shipment->saveDeliveryOptions($this->session->data['order_id'], $myparcel_shipping_choosed, $signed, $recipient_only, $current_prices);
                $model_shipment->update($this->session->data['order_id'],'type',$myparcel_shipping_code . '.' . $myparcel_shipping_code);
            }

            ]]></add>
        </operation>
    </file>
    <file path="catalog/controller/checkout/success.php">
        <operation>
            <search><![CDATA[unset($this->session->data['shipping_method']);]]></search>
            <add position="before"><![CDATA[
            if(isset($this->session->data['myparcel_shipping_choosed'])){
                unset($this->session->data['myparcel_shipping_choosed']);
            }
            if(isset($this->session->data['additional_service'])){
                unset($this->session->data['additional_service']);
            }
            if(isset($this->session->data['pickup_time_start'])){
                unset($this->session->data['pickup_time_start']);
            }
            if(isset($this->session->data['additional_service_checked'])){
                unset($this->session->data['additional_service_checked']);
            }
            if(isset($this->session->data['pickup_time_start'])){
                unset($this->session->data['pickup_time_start']);
            }
            if(isset($this->session->data['myparcel_price_pickup'])){
                unset($this->session->data['myparcel_price_pickup']);
            }
            if(isset($this->session->data['myparcel_price_delivery'])){
                unset($this->session->data['myparcel_price_delivery']);
            }
            if(isset($this->session->data['delivery_time_start'])){
                unset($this->session->data['delivery_time_start']);
            }
            if(isset($this->session->data['delivery_time_end'])){
                unset($this->session->data['delivery_time_end']);
            }
            if(isset($this->session->data['delivery_date'])){
                unset($this->session->data['delivery_date']);
            }
            if(isset($this->session->data['pickup_location'])){
                unset($this->session->data['pickup_location']);
            }
            ]]></add>
        </operation>
    </file>



    <!-- ________________ catalog/view/theme/*/template/checkout/guest_shipping.twig ________________ -->
    <!-- _______________________ Shipping Info Guest Template _______________________ -->
    <!-- _________________________________________________________________________ -->
    <file path="catalog/view/theme/*/template/checkout/guest_shipping.twig">
        <operation>
            <search><![CDATA[<input type="text" name="address_2" value="{{ address_2 }}" placeholder="{{ entry_address_2 }}" id="input-shipping-address-2" class="form-control" />]]></search>
            <add position="after"><![CDATA[
            {% if( use_addition_address  and use_addition_address == 2 ) %}
            </div>
          </div>
          <div class="form-group">
            <label class="col-sm-2 control-label" for="input-shipping-address-3">Address 3</label>
            <div class="col-sm-10">
              <input type="text" name="custom_field[address][address_3]" value="{% if (address_custom_field.address_3) %}{{ address_custom_field.address_3 }}{% endif %}" placeholder="Address 3" id="input-shipping-address-3" class="form-control" />
            {% endif %}
            ]]></add>
        </operation>
    </file>

    <!-- ________________ catalog/controller/checkout/guest.php ________________ -->
    <!-- _______________________ Billing Info Guest Controller _______________________ -->
    <!-- _________________________________________________________________________ -->
    <file path="catalog/controller/checkout/guest_shipping.php">
        <operation>
            <search><![CDATA[$this->load->language('checkout/checkout');]]></search>
            <add position="before"><![CDATA[
            $this->load->model('extension/myparcelnl/helper');
            $data['use_addition_address'] =  MyParcel($this->registry)->settings->general->use_addition_address_as_number_suffix;
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[$json['error']['address_1'] = $this->language->get('error_address_1');]]></search>
            <add position="after"><![CDATA[
            }
            $this->load->model('extension/myparcelnl/helper');
                $use_addition_address =  MyParcel($this->registry)->settings->general->use_addition_address_as_number_suffix;
                if ($use_addition_address == 2 ) {
                    if (empty(trim($this->request->post['address_2']))) {
                        $json['error']['address_2'] = MyParcel()->lang->get('error_address_2');
                    }
            ]]></add>
        </operation>
    </file>

    <!-- ________________ catalog/view/theme/*/template/checkout/register.twig ________________ -->
    <!-- _______________________ Billing Info register Template _______________________ -->
    <!-- _________________________________________________________________________ -->
    <file path="catalog/view/theme/*/template/checkout/register.twig">
        <operation>
            <search><![CDATA[<input type="text" name="address_2" value="" placeholder="{{ entry_address_2 }}" id="input-payment-address-2" class="form-control" />]]></search>
            <add position="after"><![CDATA[
            {% if( use_addition_address and use_addition_address == 2 ) %}
            </div>
              <div class="form-group">
                <label class="control-label" for="input-payment-address-3">Address 3</label>
                <input type="text" name="custom_field[address][address_3]" value="" placeholder="Address 3" id="input-payment-address-3" class="form-control" />
            {% endif %}
             ]]></add>
        </operation>
    </file>

    <!-- ________________ catalog/controller/checkout/register.php ________________ -->
    <!-- _______________________ Billing Info register Controller _______________________ -->
    <!-- _________________________________________________________________________ -->
    <file path="catalog/controller/checkout/register.php">
        <operation>
            <search><![CDATA[$this->load->language('checkout/checkout');]]></search>
            <add position="before"><![CDATA[
            $this->load->model('extension/myparcelnl/helper');
            $data['use_addition_address'] =  MyParcel($this->registry)->settings->general->use_addition_address_as_number_suffix;
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[$json['error']['address_1'] = $this->language->get('error_address_1');]]></search>
            <add position="after"><![CDATA[
            }
            $this->load->model('extension/myparcelnl/helper');
                $use_addition_address =  MyParcel($this->registry)->settings->general->use_addition_address_as_number_suffix;
                if ($use_addition_address == 2 ) {
                    if (empty(trim($this->request->post['address_2']))) {
                        $json['error']['address_2'] = MyParcel()->lang->get('error_address_2');
                    }
            ]]></add>
        </operation>
    </file>

    <!-- ________________ catalog/view/theme/*/template/checkout/payment_address.twig ________________ -->
    <!-- _______________________ Billing Info Register Template _______________________ -->
    <!-- _________________________________________________________________________ -->
    <file path="catalog/view/theme/*/template/checkout/payment_address.twig">
        <operation>
            <search><![CDATA[<input type="text" name="address_2" value="" placeholder="{{ entry_address_2 }}" id="input-payment-address-2" class="form-control" />]]></search>
            <add position="after"><![CDATA[
            {% if( use_addition_address and use_addition_address == 2 ) %}
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label" for="input-payment-address-3">Address 3</label>
            <div class="col-sm-10">
                <input type="text" name="custom_field[address][address_3]" value="" placeholder="Address 3" id="input-payment-address-3" class="form-control" />
            {% endif %}
             ]]></add>
        </operation>
    </file>

    <!-- ________________ catalog/controller/checkout/payment_address.php ________________ -->
    <!-- _______________________ Billing Info Payment Address Controller _______________________ -->
    <!-- _________________________________________________________________________ -->
    <file path="catalog/controller/checkout/payment_address.php">
        <operation>
            <search><![CDATA[$this->load->language('checkout/checkout');]]></search>
            <add position="before"><![CDATA[
            $this->load->model('extension/myparcelnl/helper');
            $data['use_addition_address'] =  MyParcel($this->registry)->settings->general->use_addition_address_as_number_suffix;
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[$json['error']['address_1'] = $this->language->get('error_address_1');]]></search>
            <add position="after"><![CDATA[
            }
            $this->load->model('extension/myparcelnl/helper');
                $use_addition_address =  MyParcel($this->registry)->settings->general->use_addition_address_as_number_suffix;
                if ($use_addition_address == 2 ) {
                    if (empty(trim($this->request->post['address_2']))) {
                        $json['error']['address_2'] = MyParcel()->lang->get('error_address_2');
                    }
            ]]></add>
        </operation>
        <operation>
            <search regex="true"><![CDATA[/elseif(.*)(\r\n|\r|\n)(\s*)\$json(.*)error_address(.*)(\r\n|\r|\n)(\s*)\}/]]></search>
            <add position="replace"><![CDATA[
            elseif (!in_array($this->request->post['address_id'], array_keys($this->model_account_address->getAddresses()))) {
                    $json['error']['warning'] = $this->language->get('error_address');
            }
            elseif (in_array($this->request->post['address_id'], array_keys($this->model_account_address->getAddresses()))) {
                $this->load->model('extension/myparcelnl/helper');
                $use_addition_address =  MyParcel($this->registry)->settings->general->use_addition_address_as_number_suffix;
                if ($use_addition_address == 2 ) {
                    $account_address = $this->model_account_address->getAddresses();
                    $account_address = $account_address[$this->request->post['address_id']];
                    if (empty(trim($account_address['address_2']))) {
                        $json['error']['warning'] = MyParcel()->lang->get('error_address_2_need_edit');
                    }
                }
            }
            ]]></add>
        </operation>
    </file>

    <!-- ________________ catalog/view/theme/*/template/checkout/shipping_address.twig ________________ -->
    <!-- _______________________ Shipping Info Register Template _______________________ -->
    <!-- _________________________________________________________________________ -->
    <file path="catalog/view/theme/*/template/checkout/shipping_address.twig">
        <operation>
            <search><![CDATA[<input type="text" name="address_2" value="" placeholder="{{ entry_address_2 }}" id="input-shipping-address-2" class="form-control" />]]></search>
            <add position="after"><![CDATA[
            {% if( use_addition_address and use_addition_address == 2 ) %}
            </div>
    </div>
    <div class="form-group">
      <label class="col-sm-2 control-label" for="input-shipping-address-3">Address 3</label>
      <div class="col-sm-10">
        <input type="text" name="custom_field[address][address_3]" value="" placeholder="Address 3" id="input-shipping-address-3" class="form-control" />
        {% endif %}
             ]]></add>
        </operation>
    </file>

    <!-- ________________ catalog/controller/checkout/shipping_address.php ________________ -->
    <!-- _______________________ Shipping Info Payment Address Controller _______________________ -->
    <!-- _________________________________________________________________________ -->
    <file path="catalog/controller/checkout/shipping_address.php">
        <operation>
            <search><![CDATA[$this->load->language('checkout/checkout');]]></search>
            <add position="before"><![CDATA[
            $this->load->model('extension/myparcelnl/helper');
            $data['use_addition_address'] =  MyParcel($this->registry)->settings->general->use_addition_address_as_number_suffix;
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[$json['error']['address_1'] = $this->language->get('error_address_1');]]></search>
            <add position="after"><![CDATA[
            }
            $this->load->model('extension/myparcelnl/helper');
                $use_addition_address =  MyParcel($this->registry)->settings->general->use_addition_address_as_number_suffix;
                if ($use_addition_address == 2 ) {
                    if (empty(trim($this->request->post['address_2']))) {
                        $json['error']['address_2'] = MyParcel()->lang->get('error_address_2');
                    }
            ]]></add>
        </operation>
        <operation>
            <search regex="true"><![CDATA[/elseif(.*)(\r\n|\r|\n)(\s*)\$json(.*)error_address(.*)(\r\n|\r|\n)(\s*)\}/]]></search>
            <add position="replace"><![CDATA[
            elseif (!in_array($this->request->post['address_id'], array_keys($this->model_account_address->getAddresses()))) {
                $json['error']['warning'] = $this->language->get('error_address');
            }
            elseif (in_array($this->request->post['address_id'], array_keys($this->model_account_address->getAddresses()))) {
                $this->load->model('extension/myparcelnl/helper');
                $use_addition_address =  MyParcel($this->registry)->settings->general->use_addition_address_as_number_suffix;
                if ($use_addition_address == 2 ) {
                    $account_address = $this->model_account_address->getAddresses();
                    $account_address = $account_address[$this->request->post['address_id']];
                    if (empty(trim($account_address['address_2']))) {
                        $json['error']['warning'] = MyParcel()->lang->get('error_address_2_need_edit');
                    }
                }
            }
            ]]></add>
        </operation>
    </file>

    <!-- ________________ catalog/view/theme/*/template/account/address_form.twig ________________ -->
    <!-- _______________________ Billing Info Register Template _______________________ -->
    <!-- _________________________________________________________________________ -->
    <file path="catalog/view/theme/*/template/account/address_form.twig">
        <operation>
            <search regex="true"><![CDATA[/<input type="text" name="address_2" value="{{ address_2 }}" placeholder="{{ entry_address_2 }}" id="input-address-2" class="form-control"(.*?)\/>/]]></search>
            <add><![CDATA[
            <input type="text" name="address_2" value="{{ address_2 }}" placeholder="{{ entry_address_2 }}" id="input-address-2" class="form-control"/>
            {% if( use_addition_address and use_addition_address == 2 ) %}
            </div>
        </div>
       <div class="form-group">
            <label class="col-sm-2 control-label" for="input-address-3">Address 3</label>
            <div class="col-sm-10">
              <input type="text" name="custom_field[address][address_3]" value="{% if (address_custom_field.address_3) %}{{ address_custom_field.address_3 }}{% endif %}" placeholder="Address 3" id="input-address-3" class="form-control" />
            {% endif %}
             ]]></add>
        </operation>
    </file>

    <!-- ________________ catalog/controller/account/address.php ________________ -->
    <!-- _______________________ Billing Info Payment Address Controller _______________________ -->
    <!-- _________________________________________________________________________ -->
    <file path="catalog/controller/account/address.php">
        <operation>
            <search><![CDATA[$data['breadcrumbs'] = array();]]></search>
            <add position="after"><![CDATA[
            $this->load->model('extension/myparcelnl/helper');
            $data['use_addition_address'] =  MyParcel($this->registry)->settings->general->use_addition_address_as_number_suffix;
            ]]></add>
        </operation>
    </file>

    <!-- ________________ catalog/controller/api/cart.php ________________ -->
    <!-- _____________ Set order delivery options to session _____________ -->
    <!-- _________________________________________________________________ -->
    <file path="catalog/controller/api/cart.php">
        <operation>
            <search><![CDATA[public function products() {]]></search>
            <add position="after"><![CDATA[
                if (isset($this->request->get['order_id'])) {
                    if (!class_exists('MyParcel')) {
                        require_once DIR_SYSTEM . 'library/myparcelnl/class_myparcel.php';
                        MyParcel($this->registry);
                    }
                    MyParcel()->shipment->checkout->setSessionOrderDeliveryOptions($this->request->get['order_id']);
                }
            ]]></add>
        </operation>
    </file>

    <!-- ________________ catalog/controller/api/order.php ________________ -->
    <!-- _____________ Set order delivery options to session _____________ -->
    <!-- _________________________________________________________________ -->
    <file path="catalog/controller/api/order.php">
        <operation>
            <search><![CDATA[$this->session->data['shipping_method'] = $this->session->data['shipping_methods'][$shipping[0]]['quote'][$shipping[1]];]]></search>
            <add position="after"><![CDATA[
                $shipping_method = $this->session->data['shipping_method'];
                if(isset($shipping_method['main_title'])){
                    $shipping_method['title'] = $shipping_method['main_title'];
                    $this->session->data['shipping_method'] = $shipping_method;
                }
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[$this->model_checkout_order->editOrder($order_id, $order_data);]]></search>
            <add position="after"><![CDATA[
                //myparcel update delivery option
                if(isset($this->session->data['myparcel_delivery_option']) ){
                    $myparcel_delivery_option = $this->session->data['myparcel_delivery_option'];
                    if (!class_exists('MyParcel')) {
                        require_once DIR_SYSTEM . 'library/myparcelnl/class_myparcel.php';
                        MyParcel($this->registry);
                    }
                    $registry = MyParcel::$registry;
                    $loader = $registry->get('load');
                    $loader->model(MyParcel()->getModelPath('shipment'));
                    $model_shipment = $registry->get('model_extension_myparcelnl_shipment');
                    if($order_data['shipping_code'] == $myparcel_delivery_option){
                        $model_shipment->update($order_id,'delivery_options',$myparcel_delivery_option);
                    }
                    $model_shipment->update($order_id,'type',$myparcel_delivery_option['shipping_code']);

                }
            ]]></add>
        </operation>
    </file>

    <!-- ________________ catalog/controller/api/shipping.php ________________ -->
    <!-- _____________ Set order delivery options to session _____________ -->
    <!-- _________________________________________________________________ -->
    <file path="catalog/controller/api/shipping.php">
        <operation>
            <search><![CDATA[public function address() {]]></search>
            <add position="after"><![CDATA[
                if (isset($this->request->post['order_id'])) {
                    if (!class_exists('MyParcel')) {
                        require_once DIR_SYSTEM . 'library/myparcelnl/class_myparcel.php';
                        MyParcel($this->registry);
                    }
                    MyParcel()->shipment->checkout->setSessionOrderDeliveryOptions($this->request->post['order_id']);
                }
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[public function methods() {]]></search>
            <add position="after"><![CDATA[
                if (isset($this->request->get['order_id'])) {
                    $this->session->data['myparcel_order_id'] = $this->request->get['order_id'];
                }
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[$results = $this->model_setting_extension->getExtensions('shipping');]]></search>
            <add position="after"><![CDATA[
                $this->load->model('checkout/order');
                $order_data = $this->model_checkout_order->getOrder($this->request->get['order_id']);
                $myparcel_key = null;
                if($this->request->get['order_id']){
                    if (!class_exists('MyParcel')) {
                        require_once DIR_SYSTEM . 'library/myparcelnl/class_myparcel.php';
                        MyParcel($this->registry);
                    }

                    $api = MyParcel()->api;
                    $registry = MyParcel::$registry;
                    /** @var \Cart\Currency $currency **/
                    $currency = $registry->get('currency');
                    $current_currency_code = $this->session->data['currency'];
                    $shipping_address = $this->session->data['shipping_address'];
                    $delivery_params = MyParcel()->helper->getDeliveryParams($shipping_address);
                    $delivery_params = MyParcel()->helper->formatDeliveryParamsEditOrder($delivery_params, $this->request->get['order_id']);
                    $myparcel_delivery = $api->getDeliveryOptions($delivery_params);
                    if(isset($myparcel_delivery['code']) && $myparcel_delivery['code'] == 200 && !isset($myparcel_delivery['body']['errors'])){
                        $next_delivery_option = MyParcel()->helper->getDeliveryOptionChange($myparcel_delivery['body']['data'],$order_data);
                        if(!empty($next_delivery_option) && $next_delivery_option['shipping_code'] != null){
                            $shipping_code = $next_delivery_option['shipping_code'];
                            $myparcel_key = 'myparcel_'. $next_delivery_option['shipping_code'];
                            $next_delivery_option['shipping_code'] = $myparcel_key . '.' . $myparcel_key;
                            $this->session->data['myparcel_delivery_option'] = $next_delivery_option;
                            $myparcel_quote = array(
                                'title' => 'MyParcel ' . ucfirst($shipping_code),
                                'sort_order' => 1,
                                'error' => ''
                            );
                            $time_delivery = $next_delivery_option['time'];
                            if(count($time_delivery) == 1){
                                $time_delivery = array_shift($next_delivery_option['time']);
                            }
                            $title = 'MyParcel ' . ucfirst($shipping_code). ' ' . date('Y-m-d',strtotime($next_delivery_option['date']));
                            if(!isset($time_delivery['price'])){
                                $time_delivery = $time_delivery[0];
                            }
                            switch ($shipping_code){
                                case "delivery":
                                    $title .= ' ( ' .ucfirst($time_delivery['price_comment']) . ' )';
                                    break;
                                case "pickup":
                                    $title .= ' ( ' . $next_delivery_option['location'] . ')';
                                    break;
                            }
                            $myparcel_quote['quote'][$myparcel_key] = array(
                                'code' => $myparcel_key . '.' . $myparcel_key,
                                'title' => $title,
                                'cost' => $time_delivery['price']['amount'],
                                'tax_class_id' => '',
                                'text' => isset($time_delivery['price']['text_amount']) ? $time_delivery['price']['text_amount'] : $currency->format($currency->convert($time_delivery['price']['amount'], $time_delivery['price']['currency'], $current_currency_code), $current_currency_code),
                                'main_title' => $myparcel_quote['title']
                            );
                        }
                    }
                }
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[array_multisort($sort_order, SORT_ASC, $json['shipping_methods']);]]></search>
            <add position="after"><![CDATA[
                if($myparcel_key != null){
                    $json['shipping_methods'][$myparcel_key] = $myparcel_quote;
                }
            ]]></add>
        </operation>
    </file>

    <!-- ________________ SHIPPING.PHP ________________ -->
    <!-- ________________ SHIPPING TOTAL ______________ -->
    <!-- _____________________________________________________ -->
    <file path="catalog/model/extension/total/shipping.php">
        <operation>
            <search><![CDATA[public function getTotal($total) {]]></search>
            <add position="after"><![CDATA[
                 /* MyParcel Ocmod Start */
                 if (!class_exists('MyParcel')) {
                    require_once DIR_SYSTEM . 'library/myparcelnl/class_myparcel.php';
                    MyParcel($this->registry);
                 }

                if (function_exists('MyParcel') && MyParcel()->shipment->checkout->appliedByParcel($total)) {
                    return $total;
                }
                /* MyParcel Ocmod End */
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[public function methods() {]]></search>
            <add position="after"><![CDATA[
                if (isset($this->request->get['order_id'])) {
                    $this->session->data['myparcel_order_id'] = $this->request->get['order_id'];
                }
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[$results = $this->model_setting_extension->getExtensions('shipping');]]></search>
            <add position="after"><![CDATA[
                $this->load->model('checkout/order');
                $order_data = $this->model_checkout_order->getOrder($this->request->get['order_id']);
                if (!class_exists('MyParcel')) {
                    require_once DIR_SYSTEM . 'library/myparcelnl/class_myparcel.php';
                    MyParcel($this->registry);
                }
                $myparcel_key = null;
                $api = MyParcel()->api;
                $shipping_address = $this->session->data['shipping_address'];
                $delivery_params = MyParcel()->helper->getDeliveryParams($shipping_address);
                $delivery_params = MyParcel()->helper->formatDeliveryParamsEditOrder($delivery_params, $this->request->get['order_id']);
                $myparcel_delivery = $api->getDeliveryOptions($delivery_params);
                if(isset($myparcel_delivery['code']) && $myparcel_delivery['code'] == 200 && !isset($myparcel_delivery['body']['errors'])){
                    $next_delivery_option = MyParcel()->helper->getDeliveryOptionChange($myparcel_delivery['body']['data'],$order_data);
                    if(!empty($next_delivery_option) && $next_delivery_option['shipping_code'] != null){
                        $myparcel_key = 'myparcel_'. $next_delivery_option['shipping_code'];
                        $myparcel_quote = array(
                            'title' => 'MyParcel ' . ucfirst($next_delivery_option['shipping_code']),
                            'sort_order' => 1,
                            'error' => ''
                        );
                        $time_delivery = $next_delivery_option['time'];
                        if(count($time_delivery) == 1){
                            $time_delivery = array_shift($next_delivery_option['time']);
                        }
                        $title = 'MyParcel ' . ucfirst($next_delivery_option['shipping_code']). ' ' . date('Y-m-d',strtotime($next_delivery_option['date']));

                        switch ($next_delivery_option['shipping_code']){
                            case "delivery":
                                $title .= ' ( ' .ucfirst($time_delivery['price_comment']) . ' )';
                                break;
                            case "pickup":
                                $title .= ' ( ' . $next_delivery_option['location'] . ')';
                                break;
                        }

                        if(!isset($time_delivery['price'])){
                            $time_delivery = $time_delivery[0];
                        }
                        $myparcel_quote['quote'][$myparcel_key] = array(
                            'code' => $myparcel_key . '.' . $myparcel_key,
                            'title' => $title,
                            'cost' => $time_delivery['price']['amount'],
                            'tax_class_id' => '',
                            'text' => $time_delivery['price']['text_amount'],
                            'main_title' => $myparcel_quote['title']
                        );
                        $next_delivery_option['shipping_code'] = $myparcel_key . '.' . $myparcel_key;
                        $this->session->data['myparcel_delivery_option'] = $next_delivery_option;
                    }
                }
            ]]></add>
        </operation>
        <operation>
            <search><![CDATA[array_multisort($sort_order, SORT_ASC, $json['shipping_methods']);]]></search>
            <add position="after"><![CDATA[
                if($myparcel_key != null){
                    $json['shipping_methods'][$myparcel_key] = $myparcel_quote;
                }
            ]]></add>
        </operation>
    </file>

    <!-- ________________ COLUMN_LEFT.PHP ________________ -->
    <!-- ____________ ADD MYPARCEL MENU TO ADMIN _________ -->
    <!-- _________________________________________________ -->
    <file path="admin/controller/common/column_left.php">
        <operation>
            <search><![CDATA[$system = array();]]></search>
            <add position="after"><![CDATA[
                 /* MyParcel Ocmod Start */
                 if (!class_exists('MyParcel')) {
                    require_once DIR_SYSTEM . 'library/myparcelnl/class_myparcel.php';
                    MyParcel($this->registry);
                }
                if (MyParcel()->helper->isModuleExist('myparcelnl')) {
                    if(version_compare(VERSION, '2.3.0.0', '>=')) {
                        $route = 'extension/module/myparcelnl';
                    } else {
                        $route = 'module/myparcelnl';
                    }

                    $system[] = array(
                        'name' => MyParcel()->lang->get('text_myparcel_menu_title'),
                        'href' => $this->url->link($route, 'user_token=' . $this->session->data['user_token'], true),
                        'children' => null
                    );
                }
                /* MyParcel Ocmod End */
            ]]></add>
        </operation>
    </file>

    <!-- ________________ MODIFY TOTAL TAX ________________ -->
    <!-- _________ ADD SHIPPING TAX TO TOTAL OF TAX _______ -->
    <!-- __________________________________________________ -->
    <file path="catalog/model/extension/total/tax.php">
        <operation>
            <search><![CDATA[if ($value > 0) {]]></search>
            <add position="after"><![CDATA[
                /* MyParcel Ocmod Start */
                $tax = 0;
                if (!empty($this->session->data['myparcel']['data'])) {
                    /** @var MyParcel_Shipment_Checkout $checkout_helper * */
                    $this->load->model('extension/myparcelnl/helper');
                    $checkout_helper = MyParcel($this->registry)->shipment->checkout;
                    $helper = MyParcel()->helper;
                    $data = $this->session->data['myparcel'];

                    if ((is_array($data['data']) && count($data['data'])) || (!is_array($data['data']) && count(json_decode(html_entity_decode($data['data']), true)))) {
                        $total_array = $checkout_helper->getTotalArray($data, false, null, '', false);
                        $total_price_without_tax = 0;

                        foreach ($total_array as $total_code => $total_item) {
                            $total_price_without_tax += $total_item['price'];
                        }
                        //get tax
                        $currentTax =$helper->getTaxRate($key);
                        if($currentTax !== false){
                            switch ($currentTax['type']){
                                case 'P' :
                                    $tax = $total_price_without_tax * ($currentTax['rate']/100);
                                    break;
                                case 'F':
                                    $tax = $currentTax['rate'];
                                    break;
                            }
                        }
                    }
                }
                $value += $tax;
                /* MyParcel Ocmod End */
            ]]></add>
        </operation>
    </file>
    <file path="admin/view/template/catalog/product_form.twig">
        <operation><!-- yes -->
            <search><![CDATA[<li><a href="#tab-data" data-toggle="tab">{{ tab_data }}</a></li>]]></search>
            <add position="after"><![CDATA[
                    <li><a href="#tab-myparcel" data-toggle="tab">My parcel</a></li>
                ]]></add>
        </operation>
        <operation>
            <search><![CDATA[<div class="tab-pane" id="tab-links">]]></search>
            <add position="before"><![CDATA[
                {{ myparcel_product_fields }}
            ]]></add>
        </operation>
    </file>

    <!-- ****** PRODUCT CONTROLLER ADMIN/CATALOG/PRODUCT.PHP ****** -->
    <!-- *************************************************** -->

    <file path="admin/controller/catalog/product.php"><!-- checked -->
        <operation><!-- yes -->
            <search><![CDATA[$this->response->setOutput($this->load->view('catalog/product_form', $data));]]></search>
            <add position="before"><![CDATA[
                $this->load->model('extension/myparcelnl/helper');
                $product_id = (isset($this->request->get['product_id'])) ? $this->request->get['product_id'] : 0;
                $data['myparcel_product_fields'] = $this->model_extension_myparcelnl_helper->getContent('edit_product_myparcel_fields', array('product_id' => $product_id));
            ]]></add>
        </operation>
    </file>

    <!-- ****** PRODUCT MODEL ADMIN/MODEL/CATALOG/PRODUCT.PHP ****** -->
    <!-- *************************************************** -->

    <file path="admin/model/catalog/product.php"><!-- checked -->
        <operation><!-- yes -->
            <search><![CDATA[$this->db->query("DELETE FROM `" . DB_PREFIX . "product_recurring` WHERE product_id = " . (int)$product_id);]]></search>
            <add position="before"><![CDATA[
                if(isset($data['myparcel_hs_code']))
                    $this->db->query("UPDATE " . DB_PREFIX . "product SET myparcel_hs_code = '" . $this->db->escape($data['myparcel_hs_code']) . "', myparcel_country = '" . $this->db->escape($data['myparcel_country']) . "' WHERE product_id = '" . (int)$product_id . "'");
            ]]></add>
        </operation>
        <operation><!-- yes -->
            <search><![CDATA[return $product_id;]]></search>
            <add position="before"><![CDATA[
                if(isset($data['myparcel_hs_code']))
                    $this->db->query("UPDATE " . DB_PREFIX . "product SET myparcel_hs_code = '" . $this->db->escape($data['myparcel_hs_code']) . "', myparcel_country = '" . $this->db->escape($data['myparcel_country']) . "' WHERE product_id = '" . (int)$product_id . "'");
            ]]></add>
        </operation>
    </file>
</modification>
